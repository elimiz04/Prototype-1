<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phrase-Level Sync</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f9f5f0;
    }

    #playButton {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      background-color: #80634F;
      color: white;
      cursor: pointer;
      z-index: 20;
    }

    #rectangle-container {
      position: absolute;
      top: 80px;
      left: 20px;
      width: 366px;
      height: 584px;
      background-color: #DEBDAA;
      border-radius: 69px;
      padding: 20px;
      overflow-y: auto;
    }

    .phrase {
      display: inline;
    }

    .highlight {
      background-color: yellow;
      font-weight: bold;
    }
  </style>
</head>
<body>

<button id="playButton">▶️ Start Audio</button>

<div id="rectangle-container">
  <div id="text-container">
    <p id="paragraph">
      As you stand atop the cliff overlooking the Mediterranean Sea, you find yourself transported over 5,000 years into the past. 
      Before cities, before written language—there was Ħaġar Qim. 
      Perched above the coastline, this sacred space was built by a community deeply connected to nature and the cosmos. 
      They raised temples using sheer will and wisdom passed down through generations. 
      A sea breeze brushes your face. 
      It’s the same wind those ancient people felt. 
      The sun above still aligns with the temple on the summer solstice—just as they intended.
    </p>
  </div>
</div>

<script>
  const playButton = document.getElementById('playButton');
  const paragraph = document.getElementById('paragraph');

  const rawText = paragraph.innerText.trim();

  // Break into short phrases (3–6 words)
  const phrases = rawText.match(/([^\.!?]+[\.!?]?)/g).flatMap(sentence => {
    const words = sentence.trim().split(/\s+/);
    const chunks = [];
    for (let i = 0; i < words.length; i += 4) {
      chunks.push(words.slice(i, i + 4).join(' '));
    }
    return chunks;
  });

  // Replace paragraph with span-wrapped phrases
  paragraph.innerHTML = phrases.map(phrase => `<span class="phrase">${phrase}</span>`).join(' ');

  const phraseSpans = document.querySelectorAll('.phrase');

  let voices = [];

  function loadVoices() {
    voices = speechSynthesis.getVoices();
    if (voices.length === 0) {
      speechSynthesis.addEventListener('voiceschanged', () => {
        voices = speechSynthesis.getVoices();
      });
    }
  }

  loadVoices();

  function speakPhrases(index = 0) {
    if (index >= phrases.length) {
      playButton.style.display = 'block';
      return;
    }

    const utter = new SpeechSynthesisUtterance(phrases[index]);
    utter.rate = 1;
    utter.lang = 'mt-MT';

    const malteseVoice = voices.find(v => v.lang === 'mt-MT') || voices.find(v => v.lang.startsWith('en'));
    if (malteseVoice) utter.voice = malteseVoice;

    // Highlight current phrase
    phraseSpans.forEach(span => span.classList.remove('highlight'));
    phraseSpans[index].classList.add('highlight');

    utter.onend = () => {
      setTimeout(() => speakPhrases(index + 1), 100); // slight pause between phrases
    };

    speechSynthesis.speak(utter);
  }

  playButton.addEventListener('click', () => {
    playButton.style.display = 'none';
    if (speechSynthesis.speaking) {
      speechSynthesis.cancel();
    }
    speakPhrases(0);
  });
</script>

</body>
</html>
