<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Natural Audio + Word-by-Word Highlight</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f9f5f0;
    }

    #playButton {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      background-color: #80634F;
      color: white;
      cursor: pointer;
      z-index: 20;
    }

    #rectangle-container {
      position: absolute;
      top: 80px;
      left: 20px;
      width: 366px;
      height: 584px;
      background-color: #DEBDAA;
      border-radius: 69px;
      padding: 20px;
      overflow-y: auto;
    }

    .word {
      display: inline;
    }

    .highlight {
      background-color: yellow;
      font-weight: bold;
    }
  </style>
</head>
<body>

<button id="playButton">▶️ Start Audio</button>

<div id="rectangle-container">
  <div id="text-container">
    <p>
      As you stand atop the cliff overlooking the Mediterranean Sea, you find yourself transported over 5,000 years into the past.
      Before cities, before written language—there was Ħaġar Qim.
      Perched above the coastline, this sacred space was built by a community deeply connected to nature and the cosmos.
      They raised temples using sheer will and wisdom passed down through generations.
      A sea breeze brushes your face.
      It’s the same wind those ancient people felt.
      The sun above still aligns with the temple on the summer solstice—just as they intended.
    </p>
  </div>
</div>

<script>
  const playButton = document.getElementById('playButton');
  const textContainer = document.getElementById('text-container');

  let voices = [];

  function loadVoices() {
    voices = speechSynthesis.getVoices();
    if (voices.length === 0) {
      speechSynthesis.addEventListener('voiceschanged', () => {
        voices = speechSynthesis.getVoices();
      });
    }
  }

  loadVoices();

  // Split text into sentences for natural reading
  const rawText = textContainer.innerText.trim();
  const sentences = rawText.match(/[^\.!\?]+[\.!\?]*/g);

  // Wrap each word in a span
  textContainer.innerHTML = sentences.map((sentence, sIndex) => {
    const words = sentence.trim().split(/\s+/);
    return words.map((word, wIndex) =>
      `<span class="word" data-index="${sIndex}-${wIndex}">${word}</span>`
    ).join(' ') + ' ';
  }).join('');

  const wordSpans = document.querySelectorAll('.word');

  function speakSentences(index = 0) {
    if (index >= sentences.length) {
      playButton.style.display = 'block';
      return;
    }

    const utter = new SpeechSynthesisUtterance(sentences[index]);
    utter.rate = 1.05;
    utter.lang = 'mt-MT';

    const voice = voices.find(v => v.lang === 'mt-MT') || voices.find(v => v.lang.startsWith('en'));
    if (voice) utter.voice = voice;

    // Highlight words in real time
    let wordOffset = 0;
    const sentenceWords = sentences[index].trim().split(/\s+/);
    utter.onboundary = (event) => {
      if (event.name === 'word') {
        wordSpans.forEach(span => span.classList.remove('highlight'));

        const span = document.querySelector(`[data-index="${index}-${wordOffset}"]`);
        if (span) {
          span.classList.add('highlight');
        }

        wordOffset++;
      }
    };

    utter.onend = () => {
      speakSentences(index + 1);
    };

    speechSynthesis.speak(utter);
  }

  playButton.addEventListener('click', () => {
    playButton.style.display = 'none';
    if (speechSynthesis.speaking) {
      speechSynthesis.cancel();
    }
    speakSentences(0);
  });
</script>

</body>
</html>
